<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>vLinker Web UI (Prototype)</title>
    <style>body{font-family:system-ui,Segoe UI,Arial;padding:16px;max-width:900px;margin:auto}textarea{width:100%;height:120px}</style>
  </head>
  <body>
    <h1>vLinker Web UI (Prototype)</h1>
    <section>
      <h2>Analyze capture</h2>
      <input id="capfile" type="file" />
      <button id="analyze">Upload & Analyze</button>
      <div id="results"></div>
      <pre id="out"></pre>
    </section>
    <section>
      <h2>Connection</h2>
      <label>Device path: <input id="device" value="/dev/ttyUSB0" /></label>
      <label>Baud: <input id="baud" value="115200" /></label>
      <button id="connect">Connect</button>
      <button id="disconnect">Disconnect</button>
      <div id="connStatus"></div>
        <label><input id="useSim" type="checkbox" /> Use Simulator</label>
    </section>
    <section>
      <h2>Diagnostics</h2>
      <button id="discover">Discover ECUs</button>
      <div id="discoverRes"></div>
      <hr />
      <label>ECU id: <input id="diagEcu" /></label>
      <button id="readDtcs">Read DTCs</button>
      <button id="clearDtcs">Clear DTCs</button>
      <pre id="dtcOut"></pre>
      <hr />
      <label>Measures (comma PIDs): <input id="measPids" /></label>
      <button id="readMeas">Read Measures</button>
      <pre id="measOut"></pre>
    </section>
    <section>
      <h2>Profiles</h2>
      <button id="refreshProfiles">Refresh Profiles</button>
      <div id="profileList"></div>
      <pre id="profilePreview"></pre>
    </section>

    <script>
      const out = document.getElementById('out')
      const results = document.getElementById('results')
      async function uploadAndAnalyze(file){
        const fd = new FormData(); fd.append('upload', file)
        out.textContent = 'Uploading...'
        const r = await fetch('/api/profile/analyze', {method:'POST', body: fd})
        if(!r.ok){ out.textContent = 'Error: '+r.statusText; return null }
        const j = await r.json()
        return j
      }

      async function uploadForBuild(file){
        const fd = new FormData(); fd.append('file', file)
        const r = await fetch('/api/capture/upload', {method:'POST', body: fd})
        if(!r.ok) throw new Error('upload failed')
        return (await r.json()).path
      }

      async function refreshProfiles(){
        const r = await fetch('/api/profile/list')
        if(!r.ok){ profileList.textContent = 'Failed to list profiles'; return }
        const j = await r.json()
        profileList.innerHTML = ''
        (j.profiles||[]).forEach(p=>{
          const d = document.createElement('div')
          d.textContent = p.name
          const btn = document.createElement('button')
          btn.textContent = 'Preview'
          btn.style.marginLeft='8px'
          btn.addEventListener('click', async ()=>{
            const pr = await fetch(`/api/profile/preview?name=${encodeURIComponent(p.name)}`)
            if(!pr.ok){ profilePreview.textContent = 'Preview failed'; return }
            const pj = await pr.json()
            profilePreview.textContent = pj.content
          })
          d.appendChild(btn)
          profileList.appendChild(d)
        })
      }

      document.getElementById('analyze').addEventListener('click', async ()=>{
        const f = document.getElementById('capfile').files[0]
        if(!f){ alert('Choose a capture file first'); return }
        try{
          const j = await uploadAndAnalyze(f)
          if(!j) return
          out.textContent = ''
          results.innerHTML = ''
          const sug = j.suggestions || []
          if(sug.length===0){ out.textContent='No suggestions found'; return }
          sug.forEach((s, idx)=>{
            const div = document.createElement('div')
            div.style.border='1px solid #ccc'; div.style.padding='8px'; div.style.margin='8px 0'
            const h = document.createElement('div')
            h.textContent = `Suggestion ${idx} â€” seed ${s.seed_hex} @ ${s.ts}`
            div.appendChild(h)
            const list = document.createElement('ul')
            (s.candidates||[]).forEach((c, ci)=>{
              const li = document.createElement('li')
              li.textContent = `${c.name} -> ${c.key_hex}`
              const btn = document.createElement('button')
              btn.textContent = 'Build profile from this candidate'
              btn.style.marginLeft='8px'
              btn.addEventListener('click', async ()=>{
                const profName = prompt('Profile name to save (e.g. my_vw_profile)')
                if(!profName) return alert('Cancelled')
                out.textContent = 'Uploading capture for build...'
                try{
                  const path = await uploadForBuild(f)
                  out.textContent = 'Building profile...'
                  const br = await fetch('/api/profile/build', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({path: path, name: profName, algo: c.name})
                  })
                  if(!br.ok){ out.textContent = 'Build failed: '+br.statusText; return }
                  const bj = await br.json()
                  out.textContent = 'Profile written to: '+bj.profile_path
                }catch(err){ out.textContent = 'Error: '+err }
              })
              li.appendChild(btn)
              list.appendChild(li)
            })
            div.appendChild(list)
            results.appendChild(div)
          })
        }catch(e){ out.textContent = 'Error: '+e }
      })

      // Connection UI
      const connStatus = document.getElementById('connStatus')
      const deviceInput = document.getElementById('device')
      const baudInput = document.getElementById('baud')
      const connectBtn = document.getElementById('connect')
      const disconnectBtn = document.getElementById('disconnect')

      async function updateStatus(){
        const r = await fetch('/api/serial/status')
        if(!r.ok){ connStatus.textContent = 'status unavailable'; return }
        const j = await r.json()
        connStatus.textContent = j.connected ? `Connected to ${j.device}` : 'Disconnected'
      }

      connectBtn.addEventListener('click', async ()=>{
        const dev = deviceInput.value
        const baud = parseInt(baudInput.value || '115200')
        const r = await fetch('/api/serial/connect', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({device: dev, baud: baud})
        })
        if(!r.ok){ connStatus.textContent = 'connect failed: '+(await r.text()); return }
        connStatus.textContent = 'connected'
        await updateStatus()
      })

      disconnectBtn.addEventListener('click', async ()=>{
        const r = await fetch('/api/serial/disconnect', {method:'POST'})
        if(!r.ok){ connStatus.textContent = 'disconnect failed'; return }
        await updateStatus()
      })

      // initial status
      const profileList = document.getElementById('profileList')
      const profilePreview = document.getElementById('profilePreview')
      updateStatus()
      // diagnostics UI wiring
      const discoverBtn = document.getElementById('discover')
      const discoverRes = document.getElementById('discoverRes')
      const diagEcu = document.getElementById('diagEcu')
      const readDtcsBtn = document.getElementById('readDtcs')
      const clearDtcsBtn = document.getElementById('clearDtcs')
      const dtcOut = document.getElementById('dtcOut')
      const readMeasBtn = document.getElementById('readMeas')
      const measPids = document.getElementById('measPids')
      const measOut = document.getElementById('measOut')

      discoverBtn.addEventListener('click', async ()=>{
        discoverRes.textContent = 'Discovering...'
          const sim = document.getElementById('useSim').checked
          const r = await fetch('/api/diag/discover'+(sim? '?use_simulator=true':''))
        if(!r.ok){ discoverRes.textContent = 'Discover failed: '+(await r.text()); return }
        const j = await r.json()
        discoverRes.textContent = JSON.stringify(j, null, 2)
      })

      readDtcsBtn.addEventListener('click', async ()=>{
        const ecu = diagEcu.value
        if(!ecu){ alert('set ECU id'); return }
        dtcOut.textContent = 'Reading...'
          const sim = document.getElementById('useSim').checked
          const r = await fetch(`/api/diag/read_dtcs?ecu=${encodeURIComponent(ecu)}${sim? '&use_simulator=true':''}`)
        if(!r.ok){ dtcOut.textContent = 'read failed: '+(await r.text()); return }
        const j = await r.json()
        dtcOut.textContent = JSON.stringify(j, null, 2)
      })

      clearDtcsBtn.addEventListener('click', async ()=>{
        const ecu = diagEcu.value
        if(!ecu){ alert('set ECU id'); return }
        if(!confirm('Clear DTCs on '+ecu+'?')) return
        dtcOut.textContent = 'Clearing...'
          const sim = document.getElementById('useSim').checked
          const r = await fetch('/api/diag/clear_dtcs', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ecu, force: true, use_simulator: sim})})
        if(!r.ok){ dtcOut.textContent = 'clear failed: '+(await r.text()); return }
        const j = await r.json()
        dtcOut.textContent = JSON.stringify(j, null, 2)
      })

      readMeasBtn.addEventListener('click', async ()=>{
        const ecu = diagEcu.value
        if(!ecu){ alert('set ECU id'); return }
        const p = (measPids.value||'').split(',').map(s=>s.trim()).filter(Boolean)
        measOut.textContent = 'Reading...'
          const sim = document.getElementById('useSim').checked
          const r = await fetch('/api/diag/read_measures', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ecu, pids: p, use_simulator: sim})})
        if(!r.ok){ measOut.textContent = 'read failed: '+(await r.text()); return }
        const j = await r.json()
        measOut.textContent = JSON.stringify(j, null, 2)
      })
    </script>
  </body>
</html>
